<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калькулятор металлопроката</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ============================================================================ */
    /* ВЗАИМОЗАВИСИМЫЕ ПОЛЯ РАСЧЁТА */
    /* ============================================================================ */

    .calculation-fields {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      border: 2px solid #dee2e6;
    }

    .section-title {
      margin: 0 0 8px 0;
      font-size: 1.15em;
      font-weight: 700;
      color: #212529;
    }

    .help-text {
      margin: 0 0 20px 0;
      font-size: 0.9em;
      color: #6c757d;
      font-style: italic;
    }

    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .flex-1 {
      flex: 1;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #495057;
      font-size: 0.95em;
    }

    .field-hint {
      color: #6c757d;
      font-size: 0.85em;
      font-weight: 400;
    }

    .form-control {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #ced4da;
      border-radius: 8px;
      font-size: 1em;
      transition: all 0.2s ease;
      background: white;
    }

    .form-control:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.15);
    }

    .form-control:hover {
      border-color: #adb5bd;
    }

    .form-control:disabled {
      background: #e9ecef;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .info-box {
      background: linear-gradient(135deg, #e7f3ff 0%, #d0e7ff 100%);
      border-left: 4px solid #0066cc;
      padding: 14px 16px;
      border-radius: 8px;
      font-size: 0.9em;
      color: #495057;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Адаптивность для мобильных */
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }

      .calculation-fields {
        padding: 16px;
      }
    }

    /* Анимация заполнения */
    .form-control.filled {
      background: #f0f9ff;
      border-color: #0066cc;
    }

    /* Error box */
    .error-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      color: #856404;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen py-8 px-4">

  <!-- Карточка калькулятора -->
  <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8">

    <!-- Заголовок -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">⚙️ Калькулятор металлопроката</h1>
      
    </div>

    <!-- Форма -->
    <form id="calculator-form" class="space-y-6">

      <!-- Тип металла -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Тип металла
          <span id="metal-count" class="text-xs text-gray-500 font-normal"></span>
        </label>
        <select id="metal-type" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition">
          <option value="">⏳ Загрузка металлов...</option>
        </select>
        <!-- ГОСТ и категория -->
        <div id="metal-info" class="mt-2 hidden">
          <p class="text-xs text-blue-700">
            <strong>📋 ГОСТ:</strong> <span id="gost-text" class="font-mono"></span>
          </p>
          <p class="text-xs text-gray-600">
            <strong>📁 Категория:</strong> <span id="category-text"></span>
          </p>
        </div>
      </div>

      <!-- Размер -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">Размер</label>
        <select
          id="size"
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition"
        >
          <option value="">-- Сначала выберите тип металла --</option>
        </select>
        <p id="size-hint" class="text-xs text-gray-500 mt-1">Выберите металл чтобы увидеть доступные размеры</p>
        <!-- Доступные размеры -->
        <div id="available-sizes" class="mt-2 hidden">
          <div class="bg-gray-50 border border-gray-200 rounded p-2">
            <p class="text-xs text-gray-700">
              <strong>📏 Доступные размеры:</strong>
              <span id="sizes-list" class="font-mono text-blue-600"></span>
            </p>
          </div>
        </div>
      </div>

      <!-- ===== НОВЫЙ БЛОК: ДИНАМИЧЕСКИЕ ПОЛЯ МАТЕРИАЛА ===== -->
      <div id="material-properties-container" class="hidden space-y-4 border-2 border-green-200 rounded-lg p-4 bg-green-50">

        <!-- Поле: Марка стали (для стандартных типов) -->
        <div id="field-steel-type" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Марка стали</label>
          <select id="steel-type-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition bg-white">
            <option value="">-- Выберите марку стали --</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Плотность стали влияет на расчёт веса</p>
        </div>

        <!-- Поле: Стандарт (ТУ) (для Листа ПВ) -->
        <div id="field-standard" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Стандарт (ТУ)</label>
          <select id="standard-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition bg-white">
            <option value="">-- Сначала выберите размер --</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Стандарт зависит от выбранного размера</p>
        </div>

        <!-- Поле: Рифление (для Листа рифленого) -->
        <div id="field-riffle-type" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Тип рифления</label>
          <select id="riffle-type-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition bg-white">
            <option value="">-- Выберите тип рифления --</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Тип рифления влияет на расчёт веса</p>
        </div>

        <!-- Поле: Оцинковка (для типов с оцинковкой) -->
        <div id="field-zinc-option" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Оцинковка</label>
          <select id="zinc-option-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition bg-white">
            <option value="">-- Выберите вариант оцинковки --</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Оцинковка добавляется к весу металла</p>
        </div>

        <!-- Поле: Марка стали (для Квадрата) -->
        <div id="field-steel-type-square" class="hidden">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Марка стали</label>
          <select id="steel-type-square-select" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition bg-white">
            <option value="">-- Выберите марку стали --</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Марка стали влияет на плотность и вес металла</p>
        </div>


      </div>
      <!-- ===== КОНЕЦ БЛОКА: ДИНАМИЧЕСКИЕ ПОЛЯ МАТЕРИАЛА ===== -->

      <!-- Специальные поля для катанки -->
      <div id="katanka-fields" class="hidden space-y-4 border-2 border-blue-200 rounded-lg p-4 bg-blue-50">

        <!-- Марка стали -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Марка стали</label>
          <select id="steel-type" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition bg-white">
            <optgroup label="Обычные стали">
              <option value="ст08">ст08 (7.871 т/м³)</option>
              <option value="ст0">ст0 (7.85 т/м³)</option>
              <option value="ст1">ст1 (7.85 т/м³)</option>
              <option value="ст2">ст2 (7.85 т/м³)</option>
              <option value="ст3" selected>ст3 (7.85 т/м³)</option>
              <option value="ст10">ст10 (7.856 т/м³)</option>
              <option value="ст15">ст15 (7.85 т/м³)</option>
              <option value="ст20">ст20 (7.859 т/м³)</option>
              <option value="ст30">ст30 (7.85 т/м³)</option>
              <option value="ст35">ст35 (7.826 т/м³)</option>
              <option value="ст40">ст40 (7.85 т/м³)</option>
              <option value="ст45">ст45 (7.826 т/м³)</option>
              <option value="ст50">ст50 (7.81 т/м³)</option>
              <option value="ст55">ст55 (7.82 т/м³)</option>
              <option value="ст60">ст60 (7.8 т/м³)</option>
            </optgroup>
            <optgroup label="Легированные стали">
              <option value="09Г2С">09Г2С (7.85 т/м³)</option>
              <option value="10Г2">10Г2 (7.79 т/м³)</option>
              <option value="15Г">15Г (7.81 т/м³)</option>
              <option value="15Х">15Х (7.83 т/м³)</option>
              <option value="20Г">20Г (7.82 т/м³)</option>
              <option value="20Х">20Х (7.83 т/м³)</option>
              <option value="30Г">30Г (7.81 т/м³)</option>
              <option value="30Х">30Х (7.82 т/м³)</option>
              <option value="35Г2">35Г2 (7.79 т/м³)</option>
              <option value="40Г">40Г (7.81 т/м³)</option>
              <option value="40Х">40Х (7.85 т/м³)</option>
              <option value="45Г2">45Г2 (7.81 т/м³)</option>
              <option value="45Х">45Х (7.82 т/м³)</option>
              <option value="50Г">50Г (7.81 т/м³)</option>
              <option value="50Г2">50Г2 (7.5 т/м³)</option>
              <option value="50Х">50Х (7.82 т/м³)</option>
              <option value="65Г">65Г (7.85 т/м³)</option>
            </optgroup>
            <optgroup label="Инструментальные стали">
              <option value="У7">У7 (7.83 т/м³)</option>
              <option value="У8">У8 (7.839 т/м³)</option>
              <option value="У10">У10 (7.81 т/м³)</option>
              <option value="У12">У12 (7.83 т/м³)</option>
            </optgroup>
            <optgroup label="Быстрорежущие стали">
              <option value="Р18">Р18 (8.8 т/м³)</option>
            </optgroup>
          </select>
          <p class="text-xs text-gray-500 mt-1">Плотность стали влияет на вес</p>
        </div>

        <!-- Длина 1 штуки -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Длина 1 штуки (м)</label>
          <input
            type="number"
            id="piece-length"
            value="1"
            step="0.1"
            min="0.1"
            placeholder="1"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition"
          >
          <p class="text-xs text-gray-500 mt-1">Используется для расчёта количества штук</p>
        </div>

      </div>

      <!-- Взаимозависимые поля расчёта -->
      <div class="calculation-fields">
        <h3 class="section-title">Параметры расчёта</h3>
        

        <div class="form-row">
          <div class="form-group flex-1">
            <label for="input-weight">
              💰 Вес
              <span class="field-hint">тонны</span>
            </label>
            <input
              type="number"
              id="input-weight"
              class="form-control"
              placeholder="0.000"
              step="0.001"
              min="0"
            >
          </div>

          <div class="form-group flex-1" id="field-length">
            <label for="input-length">
              📐 Длина
              <span class="field-hint">метры</span>
            </label>
            <input
              type="number"
              id="input-length"
              class="form-control"
              placeholder="0.00"
              step="0.01"
              min="0"
            >
          </div>

          <!-- Поле: Длина 1 шт. (показывается только для определённых типов) -->
          <div class="form-group flex-1" id="field-length-per-piece" style="display: none;">
            <label for="select-length-per-piece">
              📏 Длина 1 шт.
              <span class="field-hint">метры</span>
            </label>
            <!-- Select для выбора стандартной длины -->
            <select id="select-length-per-piece" class="form-control">
              <!-- Опции заполняются динамически из STANDARD_LENGTHS -->
            </select>
            <!-- Input для ручного ввода (показывается только при выборе н/д) -->
            <input
              type="number"
              id="input-length-per-piece-custom"
              class="form-control mt-2"
              placeholder="Введите длину в метрах"
              step="0.1"
              min="0.1"
              style="display: none;"
            >
            <!-- Подсказка под полем -->
            <div id="length-per-piece-hint" class="mt-1" style="font-size: 11px; color: #27ae60;"></div>
          </div>

          <div class="form-group flex-1" id="field-pieces">
            <label for="input-pieces">
              🔢 Количество
              <span class="field-hint">штуки</span>
            </label>
            <input
              type="number"
              id="input-pieces"
              class="form-control"
              placeholder="0"
              step="1"
              min="0"
            >
          </div>
        </div>

        <!-- ===== ПОЛЯ ДЛЯ ЛИСТОВЫХ МЕТАЛЛОВ (ОТДЕЛЬНЫЕ БЛОКИ) ===== -->

        <!-- Поле "Площадь" УДАЛЕНО - площадь считается автоматически для расчёта штук из ширины × длины -->

        <!-- Поле: Ширина -->
        <div class="form-row" id="field-width" style="display: none;">
          <div class="form-group flex-1">
            <label for="input-width">
              ↔️ Ширина
              <span class="field-hint">метры</span>
            </label>
            <input
              type="number"
              id="input-width"
              class="form-control"
              placeholder="например: 1.25"
              step="0.01"
              min="0"
            >
          </div>
        </div>

        <!-- Поле: Длина листа -->
        <div class="form-row" id="field-length-sheet" style="display: none;">
          <div class="form-group flex-1">
            <label for="input-length-sheet">
              ↕️ Длина листа
              <span class="field-hint">метры</span>
            </label>
            <input
              type="number"
              id="input-length-sheet"
              class="form-control"
              placeholder="например: 6"
              step="0.01"
              min="0"
            >
          </div>
        </div>

        <!-- Поле: Площадь (только для шпунтов) -->
        <div class="form-row" id="field-area" style="display: none;">
          <div class="form-group flex-1">
            <label for="input-area">
              📐 Площадь
              <span class="field-hint">м²</span>
            </label>
            <input
              type="number"
              id="input-area"
              class="form-control"
              placeholder="например: 100"
              step="0.01"
              min="0"
            >
          </div>
        </div>

        <!-- Автоматически рассчитанная площадь -->
        <div id="calculated-area-box" class="info-box" style="display: none; margin-top: 8px; background: #e3f2fd; border-left: 4px solid #2196f3;">
          <strong>📐 Площадь (автоматически):</strong>
          <span id="calculated-area-value">0</span> м²
        </div>

        <div class="info-box">
          ℹ️ Значения округляются кратно штукам (всегда в большую сторону)
        </div>
      </div>

    </form>

    <!-- Результат -->
    <div id="result-container" class="mt-8 hidden">
      <div id="result-card" class="p-6 rounded-lg border-4">
        <h2 class="text-2xl font-bold mb-4" id="result-title"></h2>
        <div id="result-content" class="space-y-3"></div>

        <!-- Действия с результатом -->
        <div class="mt-6 flex gap-3 flex-wrap">
          <button
            onclick="copyResultToClipboard()"
            type="button"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition"
          >
            📋 Копировать результат
          </button>
          <button
            onclick="resetCalculator()"
            type="button"
            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition"
          >
            🔄 Новый расчет
          </button>
        </div>
      </div>
    </div>

    <!-- Индикатор загрузки -->
    <div id="loading" class="mt-8 hidden">
      <div class="flex items-center justify-center space-x-3">
        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <span class="text-gray-600 font-semibold">Загрузка...</span>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <div class="text-center mt-8 text-white">
    <p class="text-xs opacity-75">
      <a href="index.html" class="hover:underline">📚 Документация</a> •
      <a href="test.html" class="hover:underline">🧪 Тестирование</a>
    </p>
  </div>

  <!-- Загрузка калькулятора -->
  <script src="./dist/calculator.browser.js"></script>

  <script>
    // Глобальные переменные
    let metalDatabase = null;
    let isLoading = false;
    let lastResult = null; // Для экспорта результата

    // Загрузка базы данных при загрузке страницы
    async function loadDatabase() {
      try {
        const response = await fetch('./database/metals.json');
        if (!response.ok) throw new Error('Не удалось загрузить базу данных');
        metalDatabase = await response.json();
        console.log('✅ База данных загружена:', Object.keys(metalDatabase.metals).length, 'металлов');

        // Заполнить dropdown металлами
        populateMetalDropdown();
      } catch (error) {
        console.error('❌ Ошибка загрузки базы:', error);
        showError('Ошибка загрузки базы данных. Проверьте подключение к интернету.');
      }
    }

    // Заполнить dropdown всеми металлами из БД с группировкой
    function populateMetalDropdown() {
      const dropdown = document.getElementById('metal-type');
      const metalCountSpan = document.getElementById('metal-count');

      // Очистить dropdown
      dropdown.innerHTML = '<option value="">-- Выберите металл --</option>';

      // Группируем металлы по категориям
      const categories = {};
      let totalCount = 0;

      for (const [key, metal] of Object.entries(metalDatabase.metals)) {
        const category = metal.category || 'Другое';
        if (!categories[category]) {
          categories[category] = [];
        }
        categories[category].push({ key, name: metal.name });
        totalCount++;
      }

      // Канонический порядок категорий (21 группа)
      const canonicalOrder = [
        'Арматура', 'Балка', 'Канат', 'Катанка', 'Квадрат', 'Крепеж', 'Круг',
        'Лента/штрипс', 'Лист/рулон', 'Плита', 'Полоса', 'Полособульб', 'Проволока',
        'Профнастил', 'Рельс', 'Сутунка', 'Труба', 'Уголок', 'Швеллер',
        'Шестигранник', 'Шпунт'
      ];

      // Сортируем категории по каноническому порядку
      const sortedCategories = Object.keys(categories).sort((a, b) => {
        const indexA = canonicalOrder.indexOf(a);
        const indexB = canonicalOrder.indexOf(b);

        // Если обе категории в каноническом порядке
        if (indexA !== -1 && indexB !== -1) {
          return indexA - indexB;
        }

        // Категории не из канонического порядка - в конец, сортируем по алфавиту
        if (indexA === -1 && indexB === -1) {
          return a.localeCompare(b, 'ru');
        }

        // Канонические категории - в начало
        return indexA !== -1 ? -1 : 1;
      });

      // Создаём optgroups для каждой категории
      sortedCategories.forEach(category => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = category;

        // Сортируем металлы внутри категории по имени
        categories[category].sort((a, b) => a.name.localeCompare(b.name, 'ru'));

        categories[category].forEach(metal => {
          const option = document.createElement('option');
          option.value = metal.key;
          option.textContent = metal.name;
          optgroup.appendChild(option);
        });

        dropdown.appendChild(optgroup);
      });

      // Показать количество металлов
      metalCountSpan.textContent = `(${totalCount} доступно)`;
      console.log(`✅ Dropdown заполнен: ${totalCount} металлов в ${sortedCategories.length} категориях`);
    }

    // Обновление информации при выборе металла
    document.getElementById('metal-type').addEventListener('change', (e) => {
      const metalType = e.target.value;

      if (!metalType || !metalDatabase) return;

      const metal = metalDatabase.metals[metalType];
      if (!metal) return;

      // 🔧 КРИТИЧЕСКИ ВАЖНО: Обновить видимость полей ширины/длины
      console.log('📊 Выбран тип металла:', metalType);
      updateSheetFieldsVisibility();

      // 🔓 Сбрасываем приоритет при смене типа металла
      if (inputPriority) {
        console.log(`🔓 Сброшен приоритет при смене типа металла: ${inputPriority}`);
        inputPriority = null;
      }

      // Показать ГОСТ и категорию
      const metalInfo = document.getElementById('metal-info');
      const gostText = document.getElementById('gost-text');
      const categoryText = document.getElementById('category-text');

      gostText.textContent = metal.gosts?.all || metal.gost || 'Не указан';
      categoryText.textContent = metal.category || 'Не указана';
      metalInfo.classList.remove('hidden');

      // ✅ ЗАПОЛНИТЬ DROPDOWN РАЗМЕРОВ (для всех металлов!)
      const sizeSelect = document.getElementById('size');
      const sizeHint = document.getElementById('size-hint');

      // Очистить dropdown
      sizeSelect.innerHTML = '<option value="">-- Выберите размер --</option>';

      // Получить все размеры (из sizes, railTypes или weights)
      let allSizes = [];

      if (metal.sizes && metal.sizes.length > 0) {
        allSizes = metal.sizes;
      } else if (metal.railTypes && metal.railTypes.length > 0) {
        // Для рельсов используем railTypes как размеры
        allSizes = metal.railTypes;
      } else if (metal.weights && Object.keys(metal.weights).length > 0) {
        allSizes = Object.keys(metal.weights);
      }

      if (allSizes.length > 0) {
        // Заполнить dropdown размерами
        allSizes.forEach(size => {
          const option = document.createElement('option');

          if (Array.isArray(size)) {
            // Для массивов (трубы, уголки): сохраняем JSON, показываем форматированно
            option.value = JSON.stringify(size);
            option.textContent = size.join('×'); // "57×3.5"
          } else {
            option.value = size;
            option.textContent = size;
          }

          sizeSelect.appendChild(option);
        });

        sizeHint.textContent = `Доступно ${allSizes.length} размеров`;
      } else {
        sizeHint.textContent = 'Введите размер вручную';
      }

      // Показать/скрыть марки стали для катанки
      const steelGradeContainer = document.getElementById('katanka-fields');
      if (metalType === 'wire_rod') {
        steelGradeContainer.classList.remove('hidden');
      } else {
        steelGradeContainer.classList.add('hidden');
      }

      // ===== НОВАЯ ЛОГИКА: ПОКАЗАТЬ/СКРЫТЬ ДИНАМИЧЕСКИЕ ПОЛЯ =====
      updateMaterialPropertiesFields(metalType, metal);

      // Автоматический расчёт после выбора металла (если есть остальные данные)
      tryAutoCalculate();
    });

    // ============================================================================
    // ВЗАИМОЗАВИСИМЫЕ ПОЛЯ (в реальном времени)
    // ============================================================================

    // ✅ ТИПЫ С ПОЛЕМ "ДЛИНА 1 ШТ." (42 типа)
    const TYPES_WITH_LENGTH_FIELD = [
      // Арматура (6)
      'armature_a1', 'armature_a1_galv', 'armature_a3', 'armature_a3_galv',
      'armature_at800', 'armature_at1000',
      // Балка, Катанка, Квадрат (3)
      'beam', 'wire_rod', 'square',
      // Круг (2)
      'circle', 'circle_galv',
      // Полоса (3)
      'strip', 'strip_galv', 'bulb_flat',
      // Рельс (1)
      'rels',
      // Трубы (19) - с правильными ключами из metals.json
      'tryba_vgp', 'tryba_vgp_ocink', 'tryba_pnd',
      'tryba_gd', 'tryba_gd_ocink', 'tryba_bs_kotelnaya',
      'tryba_xd', 'tryba_xd_ocink',
      'tryba_es_kvadr', 'tryba_es_kvadr_ocink',
      'tryba_es_oval', 'tryba_es_oval_ocink',
      'tryba_es_ploskooval', 'tryba_es_ploskooval_ocink',
      'tryba_es_pr', 'tryba_es_pr_ocink',
      'tryba_es', 'tryba_es_ocink',
      // Уголок (4)
      'ygolok', 'ygolok_gnyt', 'ygolok_gnyt_ocink', 'ygolok_ocink',
      // Швеллер (4)
      'shveller', 'shveller_gnyt', 'shveller_gnyt_ocink', 'shveller_ocink',
      // Шестигранник (1)
      'shestigrannik'
    ];

    // ✅ ТИПЫ БЕЗ ПОЛЯ "КОЛИЧЕСТВО ШТУК" (13 типов) - показывают только Вес, Длина
    const TYPES_WITHOUT_PIECES = [
      // Канаты (3)
      'rope', 'rope_armature', 'rope_galv',
      // Проволока (2)
      'wire', 'wire_galv',
      // Профнастил (2)
      'profnastil_okrash', 'profnastil_ocink',
      // Сутунка (1)
      'sytynka',
      // Шпунты (5)
      'shpynt_dvutavroviy', 'shpynt_larsen', 'shpynt_pvh',
      'shpynt_trubchatiy', 'shpynt_holodnognutiy'
    ];

    // ✅ КРЕПЕЖИ (9 типов) - только "Вес" и "Количество штук", БЕЗ поля "Длина"
    const FASTENER_TYPES = [
      'bolt',         // Болты
      'screw',        // Винты
      'nut',          // Гайки
      'nail',         // Гвозди
      'selftapping',  // Саморезы
      'washer',       // Шайбы
      'stud',         // Шпильки
      'cotter',       // Шплинты
      'woodscrew'     // Шурупы
    ];
    // СТАНДАРТНЫЕ ДЛИНЫ ДЛЯ КАЖДОГО ТИПА МЕТАЛЛА
    // Формат: { lengths: [массив длин], default: значение по умолчанию }
    // 'custom' = н/д (немерная длина, ручной ввод)
    const STANDARD_LENGTHS = {
      // === АРМАТУРА ===
      'armature_a1':      { lengths: [6, 11.7, 'custom'], default: 11.7 },
      'armature_a1_galv': { lengths: [6, 11.7, 'custom'], default: 11.7 },
      'armature_a3':      { lengths: [6, 11.7, 'custom'], default: 11.7 },
      'armature_a3_galv': { lengths: [6, 11.7, 'custom'], default: 11.7 },
      'armature_at800':   { lengths: [11.7, 10, 9.9, 6.7, 'custom'], default: 11.7 },
      'armature_at1000':  { lengths: [11.7, 10, 9.9, 6.7, 'custom'], default: 11.7 },
      // === КАТАНКА ===
      'wire_rod': { lengths: [6, 11.7, 'custom'], default: 6 },
      // === КАНАТЫ (только н/д) ===
      'rope':           { lengths: ['custom'], default: 'custom' },
      'rope_armature':  { lengths: ['custom'], default: 'custom' },
      'rope_galv':      { lengths: ['custom'], default: 'custom' },
      // === ПРОВОЛОКА (только н/д) ===
      'wire':      { lengths: ['custom'], default: 'custom' },
      'wire_galv': { lengths: ['custom'], default: 'custom' },
      // === БАЛКА ===
      'beam': { lengths: [12], default: 12 },
      // === ШВЕЛЛЕР ===
      'shveller':           { lengths: [6, 12], default: 12 },
      'shveller_ocink':     { lengths: [6, 12], default: 12 },
      'shveller_gnyt':      { lengths: [3, 6, 12], default: 6 },
      'shveller_gnyt_ocink': { lengths: [3, 6, 12], default: 6 },
      // === ТРУБЫ ВГП ===
      'tryba_vgp':       { lengths: [6, 7.8, 10, 'custom'], default: 10 },
      'tryba_vgp_ocink': { lengths: [6, 7.8, 10, 'custom'], default: 10 },
      // === ТРУБЫ КВАДРАТНЫЕ ===
      'tryba_es_kvadr':       { lengths: [6, 12, 'custom'], default: 6 },
      'tryba_es_kvadr_ocink': { lengths: [6, 12, 'custom'], default: 6 },
      // === ТРУБЫ ПРЯМОУГОЛЬНЫЕ ===
      'tryba_es_pr':       { lengths: [6, 12, 'custom'], default: 6 },
      'tryba_es_pr_ocink': { lengths: [6, 12, 'custom'], default: 6 },
      // === ТРУБЫ Э/С (электросварные) ===
      'tryba_es':       { lengths: [6, 10, 11.7, 12, 'custom'], default: 6 },
      'tryba_es_ocink': { lengths: [6, 10, 11.7, 12, 'custom'], default: 6 },
      // === ТРУБЫ Б/Ш (бесшовные) - только н/д ===
      'tryba_gd':          { lengths: ['custom'], default: 'custom' },
      'tryba_gd_ocink':    { lengths: ['custom'], default: 'custom' },
      'tryba_bs_kotelnaya': { lengths: ['custom'], default: 'custom' },
      'tryba_xd':          { lengths: ['custom'], default: 'custom' },
      'tryba_xd_ocink':    { lengths: ['custom'], default: 'custom' },
      // === ТРУБЫ ОВАЛЬНЫЕ (только н/д) ===
      'tryba_es_oval':       { lengths: ['custom'], default: 'custom' },
      'tryba_es_oval_ocink': { lengths: ['custom'], default: 'custom' },
      // === ТРУБЫ ПЛОСКООВАЛЬНЫЕ (только н/д) ===
      'tryba_es_ploskooval':       { lengths: ['custom'], default: 'custom' },
      'tryba_es_ploskooval_ocink': { lengths: ['custom'], default: 'custom' },
      // === ТРУБА ПНД (только н/д) ===
      'tryba_pnd': { lengths: ['custom'], default: 'custom' },
      // === КВАДРАТ ===
      'square': { lengths: [6, 'custom'], default: 6 },
      // === КРУГ ===
      'circle':      { lengths: [6, 'custom'], default: 6 },
      'circle_galv': { lengths: [6, 'custom'], default: 6 },
      // === ПОЛОСА ===
      'strip':      { lengths: [6, 'custom'], default: 6 },
      'strip_galv': { lengths: [6, 'custom'], default: 6 },
      'bulb_flat':  { lengths: [6, 'custom'], default: 6 },
      // === УГОЛОК ===
      'ygolok':           { lengths: [6, 12, 'custom'], default: 6 },
      'ygolok_ocink':     { lengths: [6, 12, 'custom'], default: 6 },
      'ygolok_gnyt':      { lengths: [6, 12, 'custom'], default: 6 },
      'ygolok_gnyt_ocink': { lengths: [6, 12, 'custom'], default: 6 },
      // === ШЕСТИГРАННИК ===
      'shestigrannik': { lengths: [6, 'custom'], default: 6 },
      // === РЕЛЬС (только н/д) ===
      'rels': { lengths: ['custom'], default: 'custom' },
      // === СУТУНКА (только н/д) ===
      'sytynka': { lengths: ['custom'], default: 'custom' },
      // === ПРОФНАСТИЛ (только н/д) ===
      'profnastil_okrash': { lengths: ['custom'], default: 'custom' },
      'profnastil_ocink':  { lengths: ['custom'], default: 'custom' },
      // === ШПУНТЫ (только н/д) ===
      'shpynt_dvutavroviy':   { lengths: ['custom'], default: 'custom' },
      'shpynt_larsen':        { lengths: ['custom'], default: 'custom' },
      'shpynt_pvh':           { lengths: ['custom'], default: 'custom' },
      'shpynt_trubchatiy':    { lengths: ['custom'], default: 'custom' },
      'shpynt_holodnognutiy': { lengths: ['custom'], default: 'custom' }
    };
    let isCalculating = false;  // Флаг чтобы избежать циклических пересчётов
    let debounceTimer = null;   // Таймер для debounce
    let inputPriority = null;   // Приоритет: 'weight', 'length', 'pieces' - какое поле ввели первым
    let isUpdating = false;     // Флаг для отслеживания программных обновлений полей (не от пользователя)
    let isRecalculatingFromMaterialChange = false;  // Флаг: изменение марки стали/оцинковки (не пересчитывать штуки!)

    // Получить ссылки на поля
    const weightInput = document.getElementById('input-weight');
    const lengthInput = document.getElementById('input-length');
    const lengthPerPieceSelect = document.getElementById('select-length-per-piece');
    const lengthPerPieceCustomInput = document.getElementById('input-length-per-piece-custom');
    const lengthPerPieceHint = document.getElementById('length-per-piece-hint');
    const piecesInput = document.getElementById('input-pieces');
    const areaInput = document.getElementById('input-area');  // Поле площади для шпунтов
    const widthInput = document.getElementById('input-width');
    const lengthSheetInput = document.getElementById('input-length-sheet');
    // ========================================================================
    // HELPER ФУНКЦИИ ДЛЯ РАБОТЫ СО СТАНДАРТНЫМИ ДЛИНАМИ
    // ========================================================================
    /**
     * Получить текущее значение длины 1 шт.
     * @returns {number|null} Длина в метрах или null если не установлена
     */
    function getLengthPerPiece() {
      const selectedValue = lengthPerPieceSelect.value;
      if (selectedValue === 'custom') {
        const customValue = parseFloat(lengthPerPieceCustomInput.value);
        return isNaN(customValue) || customValue <= 0 ? null : customValue;
      } else {
        return parseFloat(selectedValue);
      }
    }
    /**
     * Проверить, выбрана ли немерная длина (н/д)
     * @returns {boolean}
     */
    function isCustomLength() {
      return lengthPerPieceSelect.value === 'custom';
    }
    /**
     * Обновить опции select для выбранного типа металла
     * @param {string} metalType - ключ типа металла
     */
    function updateLengthPerPieceOptions(metalType) {
      const config = STANDARD_LENGTHS[metalType];
      if (!config) {
        console.log('Нет конфигурации стандартных длин для:', metalType);
        return;
      }
      // Очистить select
      lengthPerPieceSelect.innerHTML = '';
      // Добавить опции
      config.lengths.forEach(length => {
        const option = document.createElement('option');
        if (length === 'custom') {
          option.value = 'custom';
          option.textContent = 'н/д (ввести вручную)';
        } else {
          option.value = length;
          option.textContent = length + 'м';
        }
        lengthPerPieceSelect.appendChild(option);
      });
      // Установить значение по умолчанию
      if (config.default === 'custom') {
        lengthPerPieceSelect.value = 'custom';
      } else {
        lengthPerPieceSelect.value = config.default;
      }
      // Обновить UI
      updateLengthPerPieceUI();
      console.log('Стандартные длины для', metalType + ':', config.lengths, '| по умолчанию:', config.default);
    }
    /**
     * Обновить UI поля длины (показать/скрыть custom input, обновить подсказку)
     */
    function updateLengthPerPieceUI() {
      const isCustom = isCustomLength();
      // Показать/скрыть input для ручного ввода
      lengthPerPieceCustomInput.style.display = isCustom ? 'block' : 'none';
      // Обновить подсказку
      if (isCustom) {
        lengthPerPieceHint.innerHTML = 'Введите длину 1 шт. для расчёта';
        lengthPerPieceHint.style.color = '#3498db';  // Синий
      } else {
        lengthPerPieceHint.innerHTML = 'Расчёт кратно штукам (округление вверх)';
        lengthPerPieceHint.style.color = '#27ae60';  // Зелёный
      }
      // Показать/скрыть поле "Количество штук"
      const fieldPieces = document.getElementById('field-pieces');
      const metalType = document.getElementById('metal-type').value;
      
      // Скрываем штуки для: Плиты ИЛИ типов из TYPES_WITHOUT_PIECES
      // НО не для н/д - штуки считаются по введённой длине!
      const shouldHidePieces = metalType === 'plate' || TYPES_WITHOUT_PIECES.includes(metalType);
      
      if (fieldPieces) {
        if (shouldHidePieces) {
          console.log('Скрываем поле Количество штук (н/д или тип без штук)');
          fieldPieces.style.display = 'none';
          piecesInput.value = '';
        } else {
          console.log('Показываем поле Количество штук');
          fieldPieces.style.display = 'block';
        }
      }
    }

    /**
     * Автоматический расчёт площади из ширины × длины
     */
    /**
     * Показать площадь ОДНОГО листа (НЕ общую площадь!)
     * Это только для информации пользователю
     */
    function showSheetArea() {
      const width = parseFloat(widthInput.value);
      const length = parseFloat(lengthSheetInput.value);

      if (width && length && width > 0 && length > 0) {
        const areaPerPiece = width * length;
        document.getElementById('calculated-area-value').textContent = areaPerPiece.toFixed(2);
        document.getElementById('calculated-area-box').style.display = 'block';
      } else {
        document.getElementById('calculated-area-box').style.display = 'none';
      }
    }

    /**
     * Пересчитать ТОЛЬКО количество штук
     * Вызывается при изменении ширины/длины ОДНОГО листа
     * НЕ меняет тонны, метры или площадь!
     */
    function recalculatePiecesOnly() {
      const metalType = document.getElementById('metal-type').value;
      if (!metalType) return;

      // ⚠️ УСТАНАВЛИВАЕМ ФЛАГ: программное обновление поля pieces
      isUpdating = true;

      try {
        // Линейные типы используют метры, площадные - кв.метры
        // ТОЛЬКО Круг и Канат - линейные типы (вес на погонный метр)
        // Лист ПВ - ПЛОЩАДНОЙ тип (имеет ширину и длину листа)
        const linearTypes = ['circle', 'circle_galv', 'rope'];
        const isLinearType = linearTypes.includes(metalType);

        let totalValue = null;  // Общие метры или кв.метры

        if (isLinearType) {
          // Для линейных типов берём МЕТРЫ из поля "Длина"
          totalValue = parseFloat(lengthInput.value);
        } else {
          // Для площадных типов берём КВ.МЕТРЫ из поля "Длина"
          // (Backend записывает площадь в это поле для площадных типов)
          totalValue = parseFloat(lengthInput.value);
        }

        if (!totalValue || totalValue <= 0) {
          // Нет данных для расчёта
          piecesInput.value = '';
          return;
        }

        // Получить размеры одного листа
        const width = parseFloat(widthInput.value);
        const lengthSheet = parseFloat(lengthSheetInput.value);

        if (isLinearType) {
          // ЛИНЕЙНЫЙ ТИП: pieces = метры / длина_1_шт
          if (lengthSheet && lengthSheet > 0) {
            const pieces = Math.ceil(totalValue / lengthSheet);
            piecesInput.value = pieces;
            console.log(`📊 Пересчитаны штуки (линейный): ${totalValue} м / ${lengthSheet} м = ${pieces} шт`);
          } else {
            piecesInput.value = '';
          }
        } else {
          // ПЛОЩАДНОЙ ТИП: pieces = кв.метры / (ширина × длина)
          if (width && width > 0 && lengthSheet && lengthSheet > 0) {
            const areaPerPiece = width * lengthSheet;
            const pieces = Math.ceil(totalValue / areaPerPiece);
            piecesInput.value = pieces;
            console.log(`📊 Пересчитаны штуки (площадной): ${totalValue} м² / (${width} × ${lengthSheet}) = ${pieces} шт`);
          } else {
            piecesInput.value = '';
          }
        }
      } finally {
        // ⚠️ СНИМАЕМ ФЛАГ: программное обновление завершено
        isUpdating = false;
      }
    }

    /**
     * Функция clearWidthLength() УДАЛЕНА - поле площади больше нет
     */

    /**
     * Пересчитать все поля от одного источника
     * @param {string} sourceField - Какое поле изменил пользователь ('weight'|'length'|'pieces'|'area')
     */
    function recalculateFields(sourceField) {
      // Избегаем циклических пересчётов
      if (isCalculating) return;
      isCalculating = true;

      try {
        // Получить выбранный металл и размер
        const metalType = document.getElementById('metal-type').value;
        const sizeValue = document.getElementById('size').value;

        if (!metalType || !sizeValue) {
          isCalculating = false;
          return;  // Металл или размер не выбраны
        }

        // Получить значение из источника
        let inputValue;
        if (sourceField === 'weight') {
          inputValue = parseFloat(weightInput.value);
        } else if (sourceField === 'length') {
          inputValue = parseFloat(lengthInput.value);
        } else if (sourceField === 'pieces') {
          inputValue = parseInt(piecesInput.value);
        } else if (sourceField === 'area') {
          inputValue = parseFloat(areaInput.value);
        }

        // Если поле пустое или 0 - очистить остальные
        if (!inputValue || inputValue <= 0) {
          if (sourceField !== 'weight') weightInput.value = '';
          if (sourceField !== 'length') lengthInput.value = '';
          if (sourceField !== 'pieces') piecesInput.value = '';
          if (sourceField !== 'area' && areaInput) areaInput.value = '';
          hideResult();
          isCalculating = false;
          return;
        }

        // Парсинг размера
        let parsedSize;
        try {
          parsedSize = JSON.parse(sizeValue);
        } catch {
          parsedSize = isNaN(sizeValue) ? sizeValue : parseFloat(sizeValue);
        }

        // Собрать параметры для расчёта
        const params = {
          metalType: metalType,
          size: parsedSize
        };

        // Добавить соответствующий параметр
        if (sourceField === 'weight') {
          params.weight = inputValue;
        } else if (sourceField === 'length') {
          params.length = inputValue;
        } else if (sourceField === 'pieces') {
          params.pieces = inputValue;
        } else if (sourceField === 'area') {
          params.area = inputValue;
        }

        // Если введены ширина и длина листа - добавить их в params
        const width = parseFloat(widthInput.value);
        const lengthSheet = parseFloat(lengthSheetInput.value);
        if (width && lengthSheet && width > 0 && lengthSheet > 0) {
          params.width = width;
          params.lengthSheet = lengthSheet;
        }

        // НОВОЕ: Если активно поле "Длина 1 шт." - передать его значение как lengthSheet
        const fieldLengthPerPiece = document.getElementById('field-length-per-piece');
        const isLengthPerPieceVisible = fieldLengthPerPiece && fieldLengthPerPiece.style.display !== 'none';

        if (isLengthPerPieceVisible) {
          const lengthPerPiece = getLengthPerPiece();
          if (lengthPerPiece && lengthPerPiece > 0) {
            params.lengthSheet = lengthPerPiece;  // Backend использует это для округления штук
            console.log('  lengthSheet (из "Длина 1 шт."):', lengthPerPiece, 'м');
          }
        }

        // ===== НОВАЯ ЛОГИКА: ПЕРЕДАЧА ПАРАМЕТРОВ МАТЕРИАЛА =====

        // 1. МАРКА СТАЛИ (для стандартных типов)
        const typesWithSteel = ['circle', 'circle_galv', 'strip', 'strip_galv', 'strip_tape', 'strip_tape_painted', 'strip_tape_galv',
                                'sheet_hot', 'sheet_painted', 'sheet_galv', 'sheet_cold', 'plate', 'wire', 'wire_galv', 'sytynka', 'shestigrannik'];
        if (typesWithSteel.includes(metalType)) {
          const steelTypeSelect = document.getElementById('steel-type-select');
          if (steelTypeSelect && steelTypeSelect.value) {
            params.steelType = steelTypeSelect.value;
            console.log('  ✅ steelType:', params.steelType);
          }
        }

        // 2. СТАНДАРТ (ТУ) (для Листа ПВ)
        if (metalType === 'sheet_pv' || metalType === 'sheet_pv_galv') {
          const standardSelect = document.getElementById('standard-select');
          if (standardSelect && standardSelect.value) {
            params.standard = standardSelect.value;
            console.log('  ✅ standard:', params.standard);
          }
        }

        // 3. РИФЛЕНИЕ (для Листа рифленого)
        if (metalType === 'sheet_checkered') {
          const riffleTypeSelect = document.getElementById('riffle-type-select');
          if (riffleTypeSelect && riffleTypeSelect.value) {
            params.riffleType = riffleTypeSelect.value;
            console.log('  ✅ riffleType:', params.riffleType);
          }
        }

        // 4. ОЦИНКОВКА (для типов с оцинковкой)
        const typesWithZinc = ['strip_tape_painted', 'strip_tape_galv', 'sheet_painted', 'sheet_galv', 'sheet_pv_galv'];
        if (typesWithZinc.includes(metalType)) {
          const zincOptionSelect = document.getElementById('zinc-option-select');
          if (zincOptionSelect && zincOptionSelect.value) {
            params.zincOption = zincOptionSelect.value;
            console.log('  ✅ zincOption:', params.zincOption);
          }
        }

        // 5. МАРКА СТАЛИ (для Квадрата)
        if (metalType === 'square') {
          const steelTypeSquareSelect = document.getElementById('steel-type-square-select');
          if (steelTypeSquareSelect && steelTypeSquareSelect.value) {
            params.steelType = steelTypeSquareSelect.value;
            console.log('  ✅ steelType (для Квадрата):', params.steelType);
          }
        }

        // 6. СТАНДАРТ (для Профнастила - использует стандартное поле #standard-select)
        // Размер (тип профиля) уже в params.size из #size
        // Стандарт берётся из #standard-select (заполняется динамически при выборе размера)
        if (metalType === 'profnastil_okrash' || metalType === 'profnastil_ocink') {
          const standardSelect = document.getElementById('standard-select');
          if (standardSelect && standardSelect.value) {
            params.standard = standardSelect.value; // JSON строка {name, coefficient}
            console.log('  ✅ standard (профнастил):', params.standard);
          }
        }

        // 7. ТИП РЕЛЬСА И ВАРИАНТ (СТАНДАРТ) (для Рельса)
        // railType берётся из поля #size (например "КР70")
        // variant берётся из #standard-select (например "ГОСТ Р 53866-2010")
        if (metalType === 'rels') {
          const railType = params.size; // Тип рельса из поля размера
          const standardSelect = document.getElementById('standard-select');
          if (railType) {
            params.railType = railType;
            console.log('  ✅ railType:', params.railType);
          }
          if (standardSelect && standardSelect.value) {
            params.variant = standardSelect.value;
            console.log('  ✅ variant (рельс):', params.variant);
          }
        }

        // ===== СТАРАЯ ЛОГИКА (для обратной совместимости с катанкой) =====
        const katankaFields = document.getElementById('katanka-fields');
        if (metalType === 'wire_rod' && !katankaFields.classList.contains('hidden')) {
          const steelType = document.getElementById('steel-type');
          if (steelType) {
            params.steelType = steelType.value;
          }
        }

        // ВЫЗВАТЬ КАЛЬКУЛЯТОР
        const result = calculateMetal(params, metalDatabase);

        // ✅ ОТЛАДКА
        console.log('=== ОТЛАДКА recalculateFields ===');
        console.log('sourceField:', sourceField);
        console.log('result.success:', result.success);
        console.log('result.actual:', result.actual);
        console.log('result.actual.pieces:', result.actual ? result.actual.pieces : 'undefined');
        console.log('result.standardLength:', result.standardLength);
        console.log('Условие pieces:', sourceField !== 'pieces', '&&', result.actual && result.actual.pieces !== null);
        console.log('================================');

        if (result.success) {
          // ⚠️ УСТАНАВЛИВАЕМ ФЛАГ: программное обновление полей (не от пользователя)
          isUpdating = true;

          try {
            // Заполнить остальные поля (кроме источника)
            // ИСКЛЮЧЕНИЕ: Если вес изменился из-за округления штук - обновить поле!
            if (result.actual.weight !== null) {
              const requestedWeight = parseFloat(weightInput.value);
              const calculatedWeight = result.actual.weight;
              const weightChanged = Math.abs(calculatedWeight - requestedWeight) > 0.001;

              // Обновляем вес, если:
              // 1. sourceField !== 'weight' (обычный случай) ИЛИ
              // 2. Вес изменился из-за округления штук
              if (sourceField !== 'weight' || weightChanged) {
                weightInput.value = result.actual.weight.toFixed(3);
                if (weightChanged && sourceField === 'weight') {
                  console.log(`⚠️ Вес изменился из-за округления: ${requestedWeight.toFixed(3)} → ${calculatedWeight.toFixed(3)}`);
                }
                console.log('✅ Weight заполнен:', weightInput.value);
              }
            }

            // Аналогично для длины/площади - обновляем если изменилась из-за округления
            if (result.actual.length !== null) {
              const requestedLength = parseFloat(lengthInput.value);
              const calculatedLength = result.actual.length;
              const lengthChanged = Math.abs(calculatedLength - requestedLength) > 0.01;

              if (sourceField !== 'length' || lengthChanged) {
                lengthInput.value = result.actual.length.toFixed(2);
                if (lengthChanged && sourceField === 'length') {
                  console.log(`⚠️ Длина/площадь изменилась из-за округления: ${requestedLength.toFixed(2)} → ${calculatedLength.toFixed(2)}`);
                }
                console.log('✅ Length заполнен:', lengthInput.value);
              }
            }

            // Заполнение площади для шпунтов (3-полевой калькулятор)
            if (result.area !== undefined && result.area !== null && areaInput) {
              const requestedArea = parseFloat(areaInput.value);
              const calculatedArea = result.area;
              const areaChanged = Math.abs(calculatedArea - requestedArea) > 0.01;

              if (sourceField !== 'area' || areaChanged) {
                areaInput.value = result.area.toFixed(3);
                if (areaChanged && sourceField === 'area') {
                  console.log(`⚠️ Площадь изменилась из-за округления: ${requestedArea.toFixed(3)} → ${calculatedArea.toFixed(3)}`);
                }
                console.log('✅ Area заполнена:', areaInput.value);
              }
            }

            // ⚠️ КРИТИЧЕСКИ ВАЖНО: НЕ обновляем штуки при изменении марки стали/оцинковки!
            // Это предотвращает бесконечный рост штук из-за округления вверх
            if (sourceField !== 'pieces' && result.actual.pieces !== null && !isRecalculatingFromMaterialChange) {
              piecesInput.value = result.actual.pieces;
              console.log('✅ Pieces заполнен:', piecesInput.value);
            } else {
              if (isRecalculatingFromMaterialChange) {
                console.log('⚠️ Pieces НЕ обновлены! Изменение марки стали/оцинковки - штуки остаются неизменными');
              } else {
                console.log('❌ Pieces НЕ заполнен! sourceField:', sourceField, 'pieces:', result.actual ? result.actual.pieces : 'undefined');
              }
            }
          } finally {
            // ⚠️ СНИМАЕМ ФЛАГ: программное обновление завершено
            isUpdating = false;
          }

          // Показать результат
          showResult(result);

          // Пересчитать штуки только если backend их НЕ рассчитал
          // (например, если пользователь ввёл ширину/длину после расчёта тонн)
          if (sourceField !== 'pieces' && result.actual.pieces === null) {
            setTimeout(() => {
              recalculatePiecesOnly();
            }, 0);
          }

        } else {
          // Ошибка расчёта
          showError(result.error);
        }

      } catch (error) {
        console.error('Ошибка пересчёта:', error);
        showError(error.message);
      } finally {
        isCalculating = false;
      }
    }

    /**
     * Debounce функция (задержка перед пересчётом)
     */
    function debounceRecalculate(sourceField, delay = 500) {
      // Скрыть результаты пока идёт ввод
      hideResult();

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        recalculateFields(sourceField);
      }, delay);
    }

    /**
     * НОВАЯ ФУНКЦИЯ: Показать/скрыть и заполнить динамические поля материала
     * (Марка стали, Стандарт, Рифление, Оцинковка)
     */
    function updateMaterialPropertiesFields(metalType, metal) {
      console.log('🎨 updateMaterialPropertiesFields вызвана для:', metalType);

      // Получить контейнер и все поля
      const container = document.getElementById('material-properties-container');
      const fieldSteelType = document.getElementById('field-steel-type');
      const fieldStandard = document.getElementById('field-standard');
      const fieldRiffleType = document.getElementById('field-riffle-type');
      const fieldZincOption = document.getElementById('field-zinc-option');
      const fieldSteelTypeSquare = document.getElementById('field-steel-type-square');

      const steelTypeSelect = document.getElementById('steel-type-select');
      const standardSelect = document.getElementById('standard-select');
      const riffleTypeSelect = document.getElementById('riffle-type-select');
      const zincOptionSelect = document.getElementById('zinc-option-select');
      const steelTypeSquareSelect = document.getElementById('steel-type-square-select');

      // 1. Скрыть все поля по умолчанию
      fieldSteelType.classList.add('hidden');
      fieldStandard.classList.add('hidden');
      fieldRiffleType.classList.add('hidden');
      fieldZincOption.classList.add('hidden');
      fieldSteelTypeSquare.classList.add('hidden');

      let hasAnyField = false;

      // 2. Определить какие поля показать для данного типа

      // === МАРКА СТАЛИ (для стандартных типов) ===
      const typesWithSteel = ['circle', 'circle_galv', 'strip', 'strip_galv', 'strip_tape', 'strip_tape_painted', 'strip_tape_galv',
                              'sheet_hot', 'sheet_painted', 'sheet_galv', 'sheet_cold', 'plate', 'wire', 'wire_galv', 'sytynka', 'shestigrannik'];
      // Поддержка обоих вариантов названий полей
      const steelList = metal.steelGrades || metal.steelTypes;
      const steelCoefs = metal.steelDensities || metal.steelCoefficients;
      if (typesWithSteel.includes(metalType) && steelList && steelList.length > 0) {
        // Заполнить селект марками стали
        steelTypeSelect.innerHTML = '<option value="">-- Выберите марку стали --</option>';
        steelList.forEach(steel => {
          const option = document.createElement('option');
          option.value = steel;
          const density = steelCoefs && steelCoefs[steel]
            ? ` (${steelCoefs[steel]} кг/дм³)`
            : '';
          option.textContent = steel + density;
          steelTypeSelect.appendChild(option);
        });
        // Выбрать ст3 по умолчанию если есть
        if (steelList.includes('ст3')) {
          steelTypeSelect.value = 'ст3';
        }
        fieldSteelType.classList.remove('hidden');
        hasAnyField = true;
        console.log(`  ✅ Показано поле "Марка стали" (${steelList.length} вариантов)`);
      }

      // === СТАНДАРТ (ТУ) (для Листа ПВ) ===
      if ((metalType === 'sheet_pv' || metalType === 'sheet_pv_galv') && metal.sizeStandards) {
        // Стандарты загружаются динамически при выборе размера
        // Сейчас просто показываем поле с подсказкой
        standardSelect.innerHTML = '<option value="">-- Сначала выберите размер --</option>';
        fieldStandard.classList.remove('hidden');
        hasAnyField = true;
        console.log('  ✅ Показано поле "Стандарт (ТУ)" (будет загружено при выборе размера)');
      }

      // === РИФЛЕНИЕ (для Листа рифленого) ===
      if (metalType === 'sheet_checkered' && metal.riffleTypes && metal.riffleTypes.length > 0) {
        // Заполнить селект типами рифления
        riffleTypeSelect.innerHTML = '<option value="">-- Выберите тип рифления --</option>';
        metal.riffleTypes.forEach(riffle => {
          const option = document.createElement('option');
          option.value = riffle;
          const coef = metal.riffleCoefficients && metal.riffleCoefficients[riffle]
            ? ` (коэф. ${metal.riffleCoefficients[riffle]})`
            : '';
          option.textContent = riffle + coef;
          riffleTypeSelect.appendChild(option);
        });
        // Автоматически выбрать первый вариант рифления
        if (metal.riffleTypes.length > 0) {
          riffleTypeSelect.value = metal.riffleTypes[0];
          console.log(`  🎯 Автоматически выбрано рифление: ${metal.riffleTypes[0]}`);
        }
        fieldRiffleType.classList.remove('hidden');
        hasAnyField = true;
        console.log(`  ✅ Показано поле "Рифление" (${metal.riffleTypes.length} вариантов)`);
      }

      // === ОЦИНКОВКА (для типов с оцинковкой) ===
      const typesWithZinc = ['strip_tape_painted', 'strip_tape_galv', 'sheet_painted', 'sheet_galv', 'sheet_pv_galv'];
      // Поддержка обоих вариантов названий полей
      const galvList = metal.galvanization || metal.zincOptions;
      const galvCoefs = metal.galvanizationWeights || metal.zincCoefficients;
      if (typesWithZinc.includes(metalType) && galvList && galvList.length > 0) {
        // Заполнить селект вариантами оцинковки
        zincOptionSelect.innerHTML = '<option value="">-- Выберите вариант оцинковки --</option>';
        galvList.forEach(zinc => {
          const option = document.createElement('option');
          option.value = zinc;
          const coef = galvCoefs && galvCoefs[zinc]
            ? ` (${galvCoefs[zinc]} кг/м²)`
            : '';
          option.textContent = zinc + coef;
          zincOptionSelect.appendChild(option);
        });
        // Автоматически выбрать первый вариант оцинковки
        if (galvList.length > 0) {
          zincOptionSelect.value = galvList[0];
          console.log(`  🎯 Автоматически выбрана оцинковка: ${galvList[0]}`);
        }
        fieldZincOption.classList.remove('hidden');
        hasAnyField = true;
        console.log(`  ✅ Показано поле "Оцинковка" (${galvList.length} вариантов)`);
      }

      // === МАРКА СТАЛИ ДЛЯ КВАДРАТА ===
      if (metalType === 'square') {
        // Получить список марок стали и их плотности из базы данных
        const steelList = metal.steelTypes || metal.steelGrades;
        const steelCoefs = metal.steelCoefficients || metal.steelDensities;

        if (steelList && steelList.length > 0) {
          // Заполнить селект всеми 137 марками стали
          steelTypeSquareSelect.innerHTML = '<option value="">-- Выберите марку стали --</option>';
          steelList.forEach(steel => {
            const option = document.createElement('option');
            option.value = steel;
            const density = steelCoefs && steelCoefs[steel]
              ? ` (${steelCoefs[steel]} т/м³)`
              : '';
            option.textContent = steel + density;
            // Добавить data-атрибут с плотностью для удобства
            if (steelCoefs && steelCoefs[steel]) {
              option.setAttribute('data-density', steelCoefs[steel]);
            }
            steelTypeSquareSelect.appendChild(option);
          });

          // Выбрать ст3 по умолчанию (плотность 7.85)
          if (steelList.includes('ст3')) {
            steelTypeSquareSelect.value = 'ст3';
            console.log('  🎯 Автоматически выбрана марка стали: ст3 (7.85 т/м³)');
          }

          fieldSteelTypeSquare.classList.remove('hidden');
          hasAnyField = true;
          console.log(`  ✅ Показано поле "Марка стали для Квадрата" (${steelList.length} вариантов)`);
        }
      }

      // === СТАНДАРТ (для Профнастила) ===
      if ((metalType === 'profnastil_okrash' || metalType === 'profnastil_ocink') && metal.standards) {
        // Стандарты загружаются динамически при выборе размера (типа профиля)
        // Сейчас просто показываем поле с подсказкой
        standardSelect.innerHTML = '<option value="">-- Сначала выберите размер --</option>';
        fieldStandard.classList.remove('hidden');
        hasAnyField = true;
        console.log('  ✅ Показано поле "Стандарт" для профнастила (будет загружено при выборе размера)');
      }

      // === СТАНДАРТ (для Рельса) ===
      if (metalType === 'rels' && metal.variants) {
        // Варианты (стандарты) загружаются динамически при выборе типа рельса
        // Сейчас просто показываем поле с подсказкой
        standardSelect.innerHTML = '<option value="">-- Сначала выберите тип рельса --</option>';
        fieldStandard.classList.remove('hidden');
        hasAnyField = true;
        console.log('  ✅ Показано поле "Стандарт" для рельса (будет загружено при выборе типа)');
      }

      // 3. Показать/скрыть контейнер
      if (hasAnyField) {
        container.classList.remove('hidden');
        console.log('  ✅ Контейнер material-properties-container показан');
      } else {
        container.classList.add('hidden');
        console.log('  ⚠️  Контейнер material-properties-container скрыт (нет полей для отображения)');
      }
    }


    /**
     * Показать/скрыть поля для листовых металлов
     * КРИТИЧЕСКИ ВАЖНАЯ ФУНКЦИЯ - управляет видимостью всех полей
     */
    function updateSheetFieldsVisibility() {
      const metalType = document.getElementById('metal-type').value;

      console.log('🔧 updateSheetFieldsVisibility вызвана для типа:', metalType);

      // Получить элементы полей
      const fieldLength = document.getElementById('field-length');
      const fieldWidth = document.getElementById('field-width');
      const fieldLengthSheet = document.getElementById('field-length-sheet');
      const fieldArea = document.getElementById('field-area');
      const calculatedBox = document.getElementById('calculated-area-box');

      // Проверка существования элементов
      if (!fieldLength || !fieldWidth || !fieldLengthSheet) {
        console.error('❌ КРИТИЧЕСКАЯ ОШИБКА: Не найдены элементы полей!');
        console.error('  field-length:', fieldLength ? '✅' : '❌');
        console.error('  field-width:', fieldWidth ? '✅' : '❌');
        console.error('  field-length-sheet:', fieldLengthSheet ? '✅' : '❌');
        return;
      }

      // ===== КРЕПЕЖИ: СКРЫТЬ "ДЛИНА", ПОКАЗАТЬ "КОЛИЧЕСТВО" =====
      if (FASTENER_TYPES.includes(metalType)) {
        console.log('🔩 Тип металла - крепёж. Скрываем поле "Длина метры"');

        // Для крепежей: скрываем длину, показываем только вес и количество
        fieldLength.style.display = 'none';
        lengthInput.value = '';  // Очищаем значение

        // Скрыть все остальные дополнительные поля (листовые, длина 1 шт.)
        fieldWidth.style.display = 'none';
        fieldLengthSheet.style.display = 'none';
        if (calculatedBox) calculatedBox.style.display = 'none';

        const fieldLengthPerPiece = document.getElementById('field-length-per-piece');
        if (fieldLengthPerPiece) {
          fieldLengthPerPiece.style.display = 'none';
          lengthPerPieceCustomInput.value = '';
        }

        return;  // Выходим, больше ничего не показываем
      }

      // ===== НЕ-КРЕПЕЖИ: ПОКАЗАТЬ "ДЛИНА" =====
      console.log('📐 Тип металла - не крепёж. Показываем поле "Длина метры"');
      fieldLength.style.display = 'block';

      // ===== ОПРЕДЕЛЯЕМ ТИПЫ МЕТАЛЛОВ =====

      // Листы и ленты (нужны ширина и длина листа для расчёта штук)
      const needsSheetFields = (
        metalType === 'strip_tape' ||      // Лента/штрипс
        metalType === 'strip_tape_painted' || // Лента/штрипс окраш.
        metalType === 'strip_tape_galv' || // Лента/штрипс оц.
        metalType === 'sheet_hot' ||       // Лист/рулон г/к
        metalType === 'sheet_cold' ||      // Лист/рулон х/к
        metalType === 'sheet_galv' ||      // Лист/рулон оцинк.
        metalType === 'sheet_painted' ||   // Лист/рулон окраш.
        metalType === 'sheet_pv' ||        // Лист ПВ
        metalType === 'sheet_pv_galv' ||   // Лист ПВ оцинк.
        metalType === 'sheet_checkered'    // Лист рифленый
      );

      // ===== ПОКАЗАТЬ ИЛИ СКРЫТЬ ПОЛЯ =====

      if (needsSheetFields) {
        console.log('✅ Показываем поля ширины и длины для', metalType);

        // Показать ширину и длину листа
        fieldWidth.style.display = 'block';
        fieldLengthSheet.style.display = 'block';

        // Очистить значения при смене типа
        widthInput.value = '';
        lengthSheetInput.value = '';

        // Скрыть блок с автоматической площадью
        if (calculatedBox) calculatedBox.style.display = 'none';

      } else {
        console.log('❌ Скрываем листовые поля для', metalType);

        // Скрыть ширину и длину
        fieldWidth.style.display = 'none';
        fieldLengthSheet.style.display = 'none';

        // Скрыть блок с автоматической площадью
        if (calculatedBox) calculatedBox.style.display = 'none';
      }

      // ===== ПОКАЗАТЬ/СКРЫТЬ ПОЛЕ "ДЛИНА 1 ШТ." =====
      const fieldLengthPerPiece = document.getElementById('field-length-per-piece');
      if (fieldLengthPerPiece) {
        if (TYPES_WITH_LENGTH_FIELD.includes(metalType)) {
          console.log('✅ Показываем поле "Длина 1 шт." для', metalType);
          fieldLengthPerPiece.style.display = 'block';
          // Устанавливаем значение по умолчанию 12 м, если поле пустое
          // Обновить опции select из STANDARD_LENGTHS
          updateLengthPerPieceOptions(metalType);
        } else {
          console.log('❌ Скрываем поле "Длина 1 шт." для', metalType);
          fieldLengthPerPiece.style.display = 'none';
          lengthPerPieceCustomInput.value = '';  // Очищаем значение
        }
      }

      // ===== ПОКАЗАТЬ/СКРЫТЬ ПОЛЕ "КОЛИЧЕСТВО ШТУК" =====
      // Скрываем для: Плиты, Канатов, Проволоки, Профнастила, Сутунки, Шпунтов
      const fieldPieces = document.getElementById('field-pieces');
      if (fieldPieces) {
        const hidePieces = metalType === 'plate' || TYPES_WITHOUT_PIECES.includes(metalType);
        if (hidePieces) {
          console.log('❌ Скрываем поле "Количество штук" для', metalType);
          fieldPieces.style.display = 'none';
          piecesInput.value = '';  // Очищаем значение
        } else {
          console.log('✅ Показываем поле "Количество штук" для', metalType);
          fieldPieces.style.display = 'block';
        }
      }

      // ===== ШПУНТЫ: ПОКАЗАТЬ ПОЛЕ "ПЛОЩАДЬ" =====
      const shpyntTypes = [
        'shpynt_dvutavroviy',     // Шпунт двутавровый
        'shpynt_pvh',              // Шпунт ПВХ
        'shpynt_trubchatiy',       // Шпунт трубчатый
        'shpynt_holodnognutiy',    // Шпунт холодногнутый
        'shpynt_larsen'            // Шпунт Ларсена
      ];

      if (fieldArea) {
        if (shpyntTypes.includes(metalType)) {
          console.log('✅ Показываем поле "Площадь" для шпунта:', metalType);
          fieldArea.style.display = 'block';
        } else {
          console.log('❌ Скрываем поле "Площадь" для', metalType);
          fieldArea.style.display = 'none';
          areaInput.value = '';  // Очищаем значение
        }
      }
    }

    // ============================================================================
    // ФУНКЦИИ УПРАВЛЕНИЯ ПРИОРИТЕТОМ
    // ============================================================================

    /**
     * 🔄 ДИНАМИЧЕСКИ изменить приоритет поля
     * Вызывается когда пользователь АКТИВНО вводит значение в поле
     * (но НЕ при программном обновлении!)
     */
    function changePriority(newPriority) {
      // Если это программное обновление - не меняем приоритет
      if (isUpdating) {
        return;
      }

      // Если приоритет изменился - логируем
      if (inputPriority !== newPriority) {
        console.log(`🔄 Приоритет изменён: ${inputPriority || 'null'} → ${newPriority}`);
        inputPriority = newPriority;
      } else if (!inputPriority) {
        // Приоритет устанавливается впервые
        console.log(`🔒 Установлен приоритет поля: ${newPriority}`);
        inputPriority = newPriority;
      }
    }

    /**
     * Сбросить приоритет (при очистке всех полей или смене типа металла)
     */
    function resetPriority() {
      const weight = parseFloat(weightInput.value) || 0;
      const length = parseFloat(lengthInput.value) || 0;
      const pieces = parseInt(piecesInput.value) || 0;

      // Если все ключевые поля пустые - сбрасываем приоритет
      if (weight === 0 && length === 0 && pieces === 0) {
        if (inputPriority) {
          console.log(`🔓 Сброшен приоритет поля: ${inputPriority}`);
        }
        inputPriority = null;
      }
    }

    // ============================================================================
    // СОБЫТИЯ НА ПОЛЯХ
    // ============================================================================

    // При изменении веса
    weightInput.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value) || 0;

      if (value > 0) {
        // 🔄 ДИНАМИЧЕСКИ меняем приоритет на ВЕСТ при активном вводе пользователем
        changePriority('weight');
      }

      debounceRecalculate('weight');
      resetPriority();
    });

    // При изменении длины
    lengthInput.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value) || 0;

      if (value > 0) {
        changePriority('length');
      }

      debounceRecalculate('length');
      resetPriority();
    });

    // При изменении площади (только для шпунтов)
    areaInput.addEventListener('input', (e) => {
      const value = parseFloat(e.target.value) || 0;

      if (value > 0) {
        changePriority('area');
      }

      debounceRecalculate('area');
      resetPriority();
    });

    // При изменении количества
    piecesInput.addEventListener('input', (e) => {
      const value = parseInt(e.target.value) || 0;

      if (value > 0) {
        // 🔄 ДИНАМИЧЕСКИ меняем приоритет на КОЛИЧЕСТВО при активном вводе пользователем
        changePriority('pieces');
      }

      // Если заполнены "Длина 1 шт." и "Количество" → рассчитать общую длину
      // calculateTotalLengthFromPieces() вызовет debounceRecalculate() с учётом приоритета
      const calculated = calculateTotalLengthFromPieces();

      // Если поле "Длина 1 шт." неактивно - стандартный пересчёт
      if (!calculated) {
        debounceRecalculate('pieces');
      }

      resetPriority();
    });

    // При изменении длины 1 шт. → рассчитать общую длину автоматически
    // При выборе из select
    lengthPerPieceSelect.addEventListener('change', (e) => {
      updateLengthPerPieceUI();
      // Если есть значение в поле штук - пересчитать общую длину
      if (piecesInput.value && parseInt(piecesInput.value) > 0) {
        calculateTotalLengthFromPieces();
      } else if (weightInput.value && parseFloat(weightInput.value) > 0) {
        // Есть вес - пересчитать от веса
        debounceRecalculate('weight');
      } else if (lengthInput.value && parseFloat(lengthInput.value) > 0) {
        // Есть длина - пересчитать от длины
        debounceRecalculate('length');
      }
    });

    // При ручном вводе (когда выбрано н/д)
    lengthPerPieceCustomInput.addEventListener('input', (e) => {
      // Если есть значение в поле штук - пересчитать общую длину
      if (piecesInput.value && parseInt(piecesInput.value) > 0) {
        calculateTotalLengthFromPieces();
      } else if (weightInput.value && parseFloat(weightInput.value) > 0) {
        // Есть вес - пересчитать от веса
        debounceRecalculate('weight');
      } else if (lengthInput.value && parseFloat(lengthInput.value) > 0) {
        // Есть длина - пересчитать от длины
        debounceRecalculate('length');
      }
    });

    // Функция расчёта общей длины из "Длина 1 шт." × "Количество"
    // Возвращает true если вызвала пересчёт, false если нет
    function calculateTotalLengthFromPieces() {
      const lengthPerPiece = getLengthPerPiece();
      const pieces = parseInt(piecesInput.value);

      // Проверяем что поле "Длина 1 шт." видимо (для данного типа металла)
      const fieldLengthPerPiece = document.getElementById('field-length-per-piece');
      const isVisible = fieldLengthPerPiece && fieldLengthPerPiece.style.display !== 'none';

      if (isVisible && lengthPerPiece && pieces && lengthPerPiece > 0 && pieces > 0) {
        const totalLength = lengthPerPiece * pieces;
        lengthInput.value = totalLength.toFixed(2);
        console.log(`📐 Автоматический расчёт: ${pieces} шт × ${lengthPerPiece} м = ${totalLength} м`);

        // ✅ НОВАЯ ЛОГИКА: Учитываем приоритет поля
        // Если приоритет у weight → пересчитываем pieces (weight остаётся)
        // Если приоритет у pieces → пересчитываем weight (pieces остаётся)
        if (inputPriority === 'weight') {
          console.log(`🔒 Приоритет у ВЕСА → пересчитываем количество штук`);
          debounceRecalculate('weight');
        } else {
          // Приоритет у pieces или не установлен - стандартная логика
          console.log(`🔒 Приоритет у КОЛИЧЕСТВА (или не установлен) → пересчитываем вес`);
          piecesInput.value = pieces;
          debounceRecalculate('pieces');
        }

        return true;  // Успешно вызван пересчёт
      }

      return false;  // Поле неактивно или данные некорректны
    }

    // Поле "Площадь" удалено - площадь считается автоматически из ширины × длины

    // При изменении ширины ОДНОГО листа - пересчитать с учётом округления
    widthInput.addEventListener('input', (e) => {
      showSheetArea();  // Показать площадь 1 листа для информации

      // Если есть вес, длина или штуки - пересчитать с новыми размерами листа
      // Backend пересчитает с округлением и обновит тонны
      if (weightInput.value) {
        debounceRecalculate('weight');  // Пересчитать С округлением штук и тонн
      } else if (lengthInput.value) {
        debounceRecalculate('length');
      } else if (piecesInput.value) {
        debounceRecalculate('pieces');
      }
    });

    // При изменении длины ОДНОГО листа - пересчитать с учётом округления
    lengthSheetInput.addEventListener('input', (e) => {
      showSheetArea();  // Показать площадь 1 листа для информации

      // Если есть вес, длина или штуки - пересчитать с новыми размерами листа
      // Backend пересчитает с округлением и обновит тонны
      if (weightInput.value) {
        debounceRecalculate('weight');  // Пересчитать С округлением штук и тонн
      } else if (lengthInput.value) {
        debounceRecalculate('length');
      } else if (piecesInput.value) {
        debounceRecalculate('pieces');
      }
    });

    // При изменении металла или размера - очистить поля
    document.getElementById('metal-type').addEventListener('change', () => {
      weightInput.value = '';
      lengthInput.value = '';
      piecesInput.value = '';
      if (areaInput) areaInput.value = '';
      widthInput.value = '';
      lengthSheetInput.value = '';
      document.getElementById('calculated-area-box').style.display = 'none';
      hideResult();

      // Показать/скрыть поля для листов
      updateSheetFieldsVisibility();
    });

    document.getElementById('size').addEventListener('change', () => {
      weightInput.value = '';
      lengthInput.value = '';
      piecesInput.value = '';
      if (areaInput) areaInput.value = '';
      widthInput.value = '';
      lengthSheetInput.value = '';
      document.getElementById('calculated-area-box').style.display = 'none';

      // 🔓 Сбрасываем приоритет при смене размера
      if (inputPriority) {
        console.log(`🔓 Сброшен приоритет при смене размера: ${inputPriority}`);
        inputPriority = null;
      }

      // === ДИНАМИЧЕСКАЯ ЗАГРУЗКА СТАНДАРТОВ ДЛЯ ЛИСТА ПВ ===
      const metalType = document.getElementById('metal-type').value;
      const sizeValue = document.getElementById('size').value;

      if ((metalType === 'sheet_pv' || metalType === 'sheet_pv_galv') && sizeValue && metalDatabase) {
        const metal = metalDatabase.metals[metalType];
        if (metal && metal.sizeStandards && metal.sizeStandards[sizeValue]) {
          const standardSelect = document.getElementById('standard-select');
          standardSelect.innerHTML = '<option value="">-- Выберите стандарт --</option>';

          metal.sizeStandards[sizeValue].forEach(standard => {
            const option = document.createElement('option');
            option.value = standard.name;
            option.textContent = standard.name;
            standardSelect.appendChild(option);
          });

          // Автоматически выбрать первый стандарт
          if (metal.sizeStandards[sizeValue].length > 0) {
            const firstStandard = metal.sizeStandards[sizeValue][0].name;
            standardSelect.value = firstStandard;
            console.log(`🎯 Автоматически выбран стандарт: ${firstStandard}`);
          }

          console.log(`📐 Загружено ${metal.sizeStandards[sizeValue].length} стандартов для размера ${sizeValue}`);
        }
      }

      // === ДИНАМИЧЕСКАЯ ЗАГРУЗКА СТАНДАРТОВ ДЛЯ ПРОФНАСТИЛА ===
      if ((metalType === 'profnastil_okrash' || metalType === 'profnastil_ocink') && sizeValue && metalDatabase) {
        const metal = metalDatabase.metals[metalType];
        if (metal && metal.standards && metal.standards[sizeValue]) {
          const standardSelect = document.getElementById('standard-select');
          standardSelect.innerHTML = '<option value="">-- Выберите стандарт --</option>';

          metal.standards[sizeValue].forEach(standard => {
            const option = document.createElement('option');
            option.value = JSON.stringify({name: standard.name, coefficient: standard.coefficient});
            option.textContent = `${standard.name} (${standard.coefficient} кг/м²)`;
            standardSelect.appendChild(option);
          });

          // Автоматически выбрать первый стандарт
          if (metal.standards[sizeValue].length > 0) {
            const firstStandard = metal.standards[sizeValue][0];
            standardSelect.value = JSON.stringify({name: firstStandard.name, coefficient: firstStandard.coefficient});
            console.log(`🎯 Автоматически выбран стандарт для профнастила: ${firstStandard.name}`);
          }

          console.log(`📐 Загружено ${metal.standards[sizeValue].length} стандартов для профиля ${sizeValue}`);
        }
      }

      // === ДИНАМИЧЕСКАЯ ЗАГРУЗКА ВАРИАНТОВ (СТАНДАРТОВ) ДЛЯ РЕЛЬСА ===
      if (metalType === 'rels' && sizeValue && metalDatabase) {
        const metal = metalDatabase.metals[metalType];
        if (metal && metal.variants && metal.variants[sizeValue]) {
          const standardSelect = document.getElementById('standard-select');
          standardSelect.innerHTML = '<option value="">-- Выберите стандарт --</option>';

          metal.variants[sizeValue].forEach(variant => {
            const option = document.createElement('option');
            option.value = variant.name;
            option.textContent = `${variant.name} (${variant.coefficient.toFixed(2)} т/м)`;
            standardSelect.appendChild(option);
          });

          // Автоматически выбрать первый вариант
          if (metal.variants[sizeValue].length > 0) {
            const firstVariant = metal.variants[sizeValue][0];
            standardSelect.value = firstVariant.name;
            console.log(`🎯 Автоматически выбран стандарт для рельса: ${firstVariant.name}`);
          }

          console.log(`📐 Загружено ${metal.variants[sizeValue].length} вариантов для рельса ${sizeValue}`);
        }
      }

      hideResult();
    });

    // При изменении марки стали (катанка) - пересчитать
    document.getElementById('steel-type')?.addEventListener('change', () => {
      // Устанавливаем флаг - это изменение марки стали, НЕ обновлять source поле!
      isRecalculatingFromMaterialChange = true;
      
      // Пересчитать от того поля которое заполнено
      if (weightInput.value) {
        recalculateFields('weight');
      } else if (lengthInput.value) {
        recalculateFields('length');
      } else if (piecesInput.value) {
        recalculateFields('pieces');
      }
      
      // Сбрасываем флаг после пересчёта
      setTimeout(() => { isRecalculatingFromMaterialChange = false; }, 100);
    });

    // При изменении марки стали для Квадрата - пересчитать
    document.getElementById('steel-type-square-select')?.addEventListener('change', () => {
      console.log('🔄 Марка стали для Квадрата изменена, запускаем пересчёт');
      // Пересчитать от того поля которое заполнено
      if (weightInput.value) {
        recalculateFields('weight');
      } else if (lengthInput.value) {
        recalculateFields('length');
      } else if (piecesInput.value) {
        recalculateFields('pieces');
      }
    });

    // При изменении рифления для Листа рифленого - пересчитать
    document.getElementById('riffle-type-select')?.addEventListener('change', () => {
      console.log('🔄 Тип рифления изменён, запускаем пересчёт');
      // Пересчитать от того поля которое заполнено
      if (weightInput.value) {
        recalculateFields('weight');
      } else if (lengthInput.value) {
        recalculateFields('length');
      } else if (piecesInput.value) {
        recalculateFields('pieces');
      }
    });

    // При изменении варианта оцинковки - пересчитать
    document.getElementById('zinc-option-select')?.addEventListener('change', () => {
      console.log('🔄 Вариант оцинковки изменён, запускаем пересчёт');
      // Пересчитать от того поля которое заполнено
      if (weightInput.value) {
        recalculateFields('weight');
      } else if (lengthInput.value) {
        recalculateFields('length');
      } else if (piecesInput.value) {
        recalculateFields('pieces');
      }
    });

    // При изменении стандарта для Листа ПВ - пересчитать
    document.getElementById('standard-select')?.addEventListener('change', () => {
      console.log('🔄 Стандарт (ТУ) изменён, запускаем пересчёт');
      // Пересчитать от того поля которое заполнено
      if (weightInput.value) {
        recalculateFields('weight');
      } else if (lengthInput.value) {
        recalculateFields('length');
      } else if (piecesInput.value) {
        recalculateFields('pieces');
      }
    });

    // При изменении марки стали для других типов металлов - пересчитать
    document.getElementById('steel-type-select')?.addEventListener('change', () => {
      console.log('🔄 Марка стали изменена, запускаем пересчёт');
      // Пересчитать от того поля которое заполнено
      if (weightInput.value) {
        recalculateFields('weight');
      } else if (lengthInput.value) {
        recalculateFields('length');
      } else if (piecesInput.value) {
        recalculateFields('pieces');
      }
    });

    // При изменении стандарта (Лист ПВ) - пересчитать
    const standardSelect = document.getElementById('standard-select');
    if (standardSelect) {
      standardSelect.addEventListener('change', () => {
        console.log('🔄 Стандарт изменён, пересчитываю...');
        if (weightInput.value) {
          recalculateFields('weight');
        } else if (lengthInput.value) {
          recalculateFields('length');
        } else if (piecesInput.value) {
          recalculateFields('pieces');
        } else if (areaInput.value) {
          recalculateFields('area');
        }
      });
    }

    // При изменении марки стали - пересчитать ТОЛЬКО ВЕС (НЕ штуки!)
    const steelTypeSelect = document.getElementById('steel-type-select');
    if (steelTypeSelect) {
      steelTypeSelect.addEventListener('change', () => {
        console.log('🔄 Марка стали изменена, пересчитываю ТОЛЬКО вес (штуки НЕ трогаем)...');

        // ⚠️ ВАЖНО: Устанавливаем флаг, чтобы НЕ пересчитывать штуки!
        isRecalculatingFromMaterialChange = true;

        try {
          if (weightInput.value) {
            recalculateFields('weight');
          } else if (lengthInput.value) {
            recalculateFields('length');
          } else if (piecesInput.value) {
            recalculateFields('pieces');
          }
        } finally {
          // ⚠️ ВАЖНО: Сбрасываем флаг после пересчёта
          isRecalculatingFromMaterialChange = false;
        }
      });
    }

    // При изменении типа рифления (Лист рифленый) - пересчитать
    const riffleTypeSelect = document.getElementById('riffle-type-select');
    if (riffleTypeSelect) {
      riffleTypeSelect.addEventListener('change', () => {
        console.log('🔄 Тип рифления изменён, пересчитываю...');
        if (weightInput.value) {
          recalculateFields('weight');
        } else if (lengthInput.value) {
          recalculateFields('length');
        } else if (piecesInput.value) {
          recalculateFields('pieces');
        } else if (areaInput.value) {
          recalculateFields('area');
        }
      });
    }

    // При изменении опции цинкования - пересчитать ТОЛЬКО ВЕС (НЕ штуки!)
    const zincOptionSelect = document.getElementById('zinc-option-select');
    if (zincOptionSelect) {
      zincOptionSelect.addEventListener('change', () => {
        console.log('🔄 Опция цинкования изменена, пересчитываю ТОЛЬКО вес (штуки НЕ трогаем)...');

        // ⚠️ ВАЖНО: Устанавливаем флаг, чтобы НЕ пересчитывать штуки!
        isRecalculatingFromMaterialChange = true;

        try {
          if (weightInput.value) {
            recalculateFields('weight');
          } else if (lengthInput.value) {
            recalculateFields('length');
          } else if (piecesInput.value) {
            recalculateFields('pieces');
          }
          // areaInput удалён
        } finally {
          // ⚠️ ВАЖНО: Сбрасываем флаг после пересчёта
          isRecalculatingFromMaterialChange = false;
        }
      });
    }

    // Функция скрытия результата
    function hideResult() {
      const resultDiv = document.getElementById('result-container');
      if (resultDiv) {
        resultDiv.classList.add('hidden');
      }
    }

    // Функция отображения ошибки
    function showError(message) {
      const resultContainer = document.getElementById('result-container');
      const resultCard = document.getElementById('result-card');
      const resultTitle = document.getElementById('result-title');
      const resultContent = document.getElementById('result-content');

      resultCard.className = 'p-6 rounded-lg border-4 border-red-500 bg-red-50';
      resultTitle.textContent = '❌ Ошибка';
      resultTitle.className = 'text-2xl font-bold mb-4 text-red-700';
      resultContent.innerHTML = `
        <div class="error-box">
          ${message}
        </div>
      `;

      resultContainer.classList.remove('hidden');
    }

    // ============================================================================
    // КОНЕЦ ЛОГИКИ ВЗАИМОЗАВИСИМЫХ ПОЛЕЙ
    // ============================================================================

    // Обработка формы (теперь почти не используется, т.к. всё автоматом)
    // Оставляем минимальный обработчик чтобы форма не отправлялась
    document.getElementById('calculator-form').addEventListener('submit', (e) => {
      // Блокируем submit - теперь всё происходит автоматически через взаимозависимые поля
      e.preventDefault();
      console.log('⚠️ Submit заблокирован - используйте взаимозависимые поля (вес/длина/количество)');
    });

    // Показать результат
    function showResult(result) {
      // Сохраняем результат для экспорта
      lastResult = result;

      const container = document.getElementById('result-container');
      const card = document.getElementById('result-card');
      const title = document.getElementById('result-title');
      const content = document.getElementById('result-content');

      // Успешный результат - зеленая рамка
      card.className = 'p-6 rounded-lg border-4 border-green-500 bg-green-50';
      title.textContent = '✅ Результат расчета';
      title.className = 'text-2xl font-bold mb-4 text-green-700';

      // ✅ НОВАЯ ЛОГИКА: Если есть requested/actual - используем улучшенное отображение
      if (result.requested && result.actual) {
        content.innerHTML = createEnhancedResult(result);
      } else {
        // Fallback на старое отображение (обратная совместимость)
        content.innerHTML = createLegacyResult(result);
      }

      container.classList.remove('hidden');

      // Прокрутка к результату ОТКЛЮЧЕНА (UX: не мешаем вводу)
      // setTimeout(() => {
      //   container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      // }, 100);
    }

    // ✅ НОВАЯ ФУНКЦИЯ: Улучшенное отображение с requested/actual/difference
    function createEnhancedResult(result) {
      let html = '';

      // === СЕКЦИЯ 1: ОСНОВНАЯ ИНФОРМАЦИЯ ===
      html += '<div class="mb-6 p-4 bg-white rounded-lg border-2 border-gray-200">';
      html += '<h4 class="text-sm font-bold text-gray-600 uppercase tracking-wide mb-3">📋 Информация о металле</h4>';

      html += createResultRow('📦 Металл', result.metalType);

      const formattedSize = Array.isArray(result.size)
        ? result.size.join('×') + ' мм'
        : (typeof result.size === 'number' ? result.size + ' мм' : result.size);
      html += createResultRow('📏 Размер', formattedSize);

      if (result.steelType) {
        html += createResultRow('🔩 Марка стали', result.steelType);
      }

      html += createResultRow('📋 ГОСТ', result.gost);

      // Показывать вес 1 метра только если он определён (для профнастила его нет)
      if (result.weightPerMeter !== null && result.weightPerMeter !== undefined) {
        html += createResultRow('⚖️ Вес 1 метра', result.weightPerMeter.toFixed(3) + ' кг');
      }

      if (result.standardLength) {
        html += createResultRow('📐 Стандартная длина', result.standardLength + ' м');
      }

      html += '</div>';

      // === СЕКЦИЯ 2: ЗАПРОШЕНО ===
      html += '<div class="mb-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">';
      html += '<h4 class="text-sm font-bold text-blue-700 uppercase tracking-wide mb-2">📝 Запрошено:</h4>';
      html += `<p class="text-2xl font-bold text-blue-900">${result.requested.label}</p>`;
      html += '</div>';

      // === СЕКЦИЯ 3: ФАКТИЧЕСКИ (КРАТНО ШТУКАМ) ===
      html += '<div class="mb-6 p-5 bg-green-50 rounded-lg border-3 border-green-400 shadow-sm">';
      html += '<h4 class="text-sm font-bold text-green-700 uppercase tracking-wide mb-4">✅ Фактически (кратно штукам):</h4>';

      // Количество штук
      if (result.actual.pieces !== null) {
        let piecesText = `<strong>${result.actual.pieces} шт</strong>`;

        // Используем значение из поля "Длина 1 шт." если оно доступно
        const fieldLengthPerPiece = document.getElementById('field-length-per-piece');
        const isFieldVisible = fieldLengthPerPiece && fieldLengthPerPiece.style.display !== 'none';
        const lengthPerPiece = getLengthPerPiece();

        if (isFieldVisible && lengthPerPiece && lengthPerPiece > 0) {
          // Используем введённое пользователем значение
          piecesText += ` × ${lengthPerPiece}м`;
        } else if (result.standardLength) {
          // Используем стандартное значение из базы
          piecesText += ` × ${result.standardLength}м`;
        }

        html += createHighlightRow('🔢 Количество', piecesText);
      }

      // Длина с разницей
      if (result.actual.length !== null) {
        let lengthText = `<strong>${result.actual.length} м</strong>`;
        if (result.difference && result.difference.length) {
          lengthText += ` <span class="inline-block ml-2 px-3 py-1 bg-green-600 text-white text-sm font-bold rounded-full">${result.difference.length}</span>`;
        }
        html += createHighlightRow('📐 Длина', lengthText);
      }

      // Вес с разницей
      if (result.actual.weight !== null) {
        const weightKg = (result.actual.weight * 1000).toFixed(1);
        let weightText = `<strong>${result.actual.weight} т</strong> (${weightKg} кг)`;
        if (result.difference && result.difference.weight) {
          weightText += ` <span class="inline-block ml-2 px-3 py-1 bg-green-600 text-white text-sm font-bold rounded-full">${result.difference.weight}</span>`;
        }
        html += createHighlightRow('💰 Вес', weightText);
      }

      html += '</div>';

      return html;
    }

    // Создать строку с подсветкой для фактических значений
    function createHighlightRow(label, value) {
      return `
        <div class="flex justify-between items-center p-3 mb-2 bg-white rounded-lg border border-green-200">
          <span class="text-gray-700 font-semibold">${label}</span>
          <span class="text-green-900 text-lg">${value}</span>
        </div>
      `;
    }

    // ⚠️ СТАРАЯ ФУНКЦИЯ: Для обратной совместимости
    function createLegacyResult(result) {
      let html = '';

      html += createResultRow('📦 Металл', result.metalType);

      const formattedSize = Array.isArray(result.size)
        ? result.size.join('×') + ' мм'
        : (typeof result.size === 'number' ? result.size + ' мм' : result.size);

      html += createResultRow('📏 Размер', formattedSize);

      if (result.steelType) {
        html += createResultRow('🔩 Марка стали', result.steelType);
      }

      html += createResultRow('📋 ГОСТ', result.gost);
      html += createResultRow('⚖️ Вес 1 метра', result.weightPerMeter.toFixed(3) + ' кг');

      if (result.weight !== undefined) {
        html += createResultRow('💰 Общий вес', (result.weight * 1000).toFixed(2) + ' кг', true);
      }

      if (result.length !== undefined) {
        html += createResultRow('📐 Длина', result.length.toFixed(2) + ' м', true);
      }

      if (result.pieces !== undefined) {
        html += createResultRow('🔢 Количество', result.pieces + ' шт', true);
      }

      return html;
    }

    // Создать строку результата
    function createResultRow(label, value, highlight = false) {
      const bgClass = highlight ? 'bg-green-100' : 'bg-white';
      const textClass = highlight ? 'text-green-900 font-bold text-lg' : 'text-gray-700';

      return `
        <div class="flex justify-between items-center p-3 ${bgClass} rounded-lg">
          <span class="text-gray-600 font-medium">${label}</span>
          <span class="${textClass}">${value}</span>
        </div>
      `;
    }

    // Показать ошибку
    function showError(message) {
      const container = document.getElementById('result-container');
      const card = document.getElementById('result-card');
      const title = document.getElementById('result-title');
      const content = document.getElementById('result-content');

      // Ошибка - красная рамка
      card.className = 'p-6 rounded-lg border-4 border-red-500 bg-red-50';
      title.textContent = '❌ Ошибка';
      title.className = 'text-2xl font-bold mb-4 text-red-700';
      content.innerHTML = `
        <div class="text-red-700">
          <p class="text-lg">${message}</p>
        </div>
      `;

      container.classList.remove('hidden');

      // Прокрутка к ошибке ОТКЛЮЧЕНА (UX: не мешаем вводу)
      // setTimeout(() => {
      //   container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      // }, 100);
    }

    // Показать/скрыть индикатор загрузки
    function showLoading(show) {
      isLoading = show;
      const loading = document.getElementById('loading');
      const resultContainer = document.getElementById('result-container');

      if (show) {
        loading.classList.remove('hidden');
        resultContainer.classList.add('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }

    // Копировать результат в буфер обмена
    function copyResultToClipboard() {
      if (!lastResult) {
        alert('⚠️ Нет результата для копирования');
        return;
      }

      // ✅ Форматируем размер для труб
      const formattedSize = Array.isArray(lastResult.size)
        ? lastResult.size.join('×') + ' мм'
        : (typeof lastResult.size === 'number' ? lastResult.size + ' мм' : lastResult.size);

      const text = `
═══════════════════════════════════════
  РЕЗУЛЬТАТ РАСЧЁТА - Калькулятор металла
═══════════════════════════════════════

📦 Металл: ${lastResult.metalType}
📏 Размер: ${formattedSize}
${lastResult.steelType ? `🔩 Марка стали: ${lastResult.steelType}\n` : ''}📋 ГОСТ: ${lastResult.gost}
📁 Категория: ${lastResult.category}

⚖️  Вес 1 метра: ${lastResult.weightPerMeter.toFixed(3)} кг
${lastResult.weight !== undefined ? `💰 Общий вес: ${(lastResult.weight * 1000).toFixed(2)} кг (${lastResult.weight.toFixed(3)} т)\n` : ''}${lastResult.length !== undefined ? `📐 Длина: ${lastResult.length.toFixed(2)} м\n` : ''}${lastResult.pieces !== undefined ? `🔢 Количество: ${lastResult.pieces} шт\n` : ''}
📅 Дата расчёта: ${new Date().toLocaleString('ru-RU')}

═══════════════════════════════════════
Powered by Metal Calculator API
      `.trim();

      navigator.clipboard.writeText(text).then(() => {
        alert('✅ Результат скопирован в буфер обмена!');
      }).catch(err => {
        console.error('Ошибка копирования:', err);
        alert('❌ Не удалось скопировать. Попробуйте вручную.');
      });
    }

    // Сбросить форму для нового расчета
    function resetCalculator() {
      // Скрыть результат
      document.getElementById('result-container').classList.add('hidden');

      // Очистить форму
      document.getElementById('calculator-form').reset();

      // Скрыть дополнительные блоки
      document.getElementById('metal-info').classList.add('hidden');
      document.getElementById('available-sizes').classList.add('hidden');
      document.getElementById('katanka-fields').classList.add('hidden');

      // Сбросить последний результат
      lastResult = null;

      // Прокрутить к началу формы
      document.getElementById('calculator-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ✅ АВТОМАТИЧЕСКИЙ РАСЧЁТ (Исправление UX 2/2)

    // Debounce функция для предотвращения частых вызовов
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Попытка автоматического расчёта
    async function tryAutoCalculate() {
      // Проверки
      if (isLoading || !metalDatabase) return;

      const metalType = document.getElementById('metal-type').value;
      const size = document.getElementById('size').value;
      const value = document.getElementById('value').value;

      // Минимальные поля должны быть заполнены
      if (!metalType || !size || !value || value <= 0) return;

      // Программно вызываем submit формы
      const form = document.getElementById('calculator-form');
      const submitEvent = new Event('submit', { cancelable: true, bubbles: true });
      form.dispatchEvent(submitEvent);
    }

    // Добавить автоматический расчёт на изменение полей
    function setupAutoCalculate() {
      // Event listeners для полей
      const fields = [
        { id: 'metal-type', event: 'change' },
        { id: 'size', event: 'change' },
        { id: 'steel-type', event: 'change' },
        { id: 'piece-length', event: 'input', debounced: true }
      ];

      fields.forEach(({ id, event, debounced }) => {
        const element = document.getElementById(id);
        if (element) {
          if (debounced) {
            element.addEventListener(event, debounce(tryAutoCalculate, 800));
          } else {
            element.addEventListener(event, tryAutoCalculate);
          }
        }
      });

      console.log('✅ Автоматический расчёт включён');
    }

    // Загрузка базы данных при старте
    loadDatabase().then(() => {
      // После загрузки БД включаем автоматический расчёт
      setupAutoCalculate();

      // ===== ОТЛАДКА: Проверка существования элементов =====
      console.log('📱 Калькулятор загружен');
      console.log('📦 Проверка элементов листовых полей:');
      console.log('  - field-area:', document.getElementById('field-area') ? '✅' : '❌');
      console.log('  - field-width:', document.getElementById('field-width') ? '✅' : '❌');
      console.log('  - field-length-sheet:', document.getElementById('field-length-sheet') ? '✅' : '❌');
      console.log('  - input-area:', document.getElementById('input-area') ? '✅' : '❌');
      console.log('  - input-width:', document.getElementById('input-width') ? '✅' : '❌');
      console.log('  - input-length-sheet:', document.getElementById('input-length-sheet') ? '✅' : '❌');

      // ===== ВЫЗВАТЬ updateSheetFieldsVisibility ЕСЛИ УЖЕ ВЫБРАН ТИП =====
      const metalTypeSelect = document.getElementById('metal-type');
      if (metalTypeSelect && metalTypeSelect.value) {
        console.log('🔄 Инициализация полей для уже выбранного типа:', metalTypeSelect.value);
        updateSheetFieldsVisibility();
      }
    });
  </script>
</body>
</html>